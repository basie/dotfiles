#!/usr/bin/env bash

[[ "$(type -P git)" ]] || { echo "Git required."; exit 1; }

function init() {
  if [[ -d ~/.config ]]; then
    export DOTFILES="${HOME}/.config/dotfiles";
  else
    export DOTFILES="${HOME}/.dotfiles";
  fi

  [[ -d $DOTFILES/bin ]] && PATH=$DOTFILES/bin:$PATH
  export PATH

  shopt -s dotglob
  shopt -s nullglob
}

function src() {
  local file
  for file in ${DOTFILES}/lib/*; do
    echo "$file"
    source "$file"
  done
}

function clone() {
  if [[ ! -d $DOTFILES ]]; then
    git clone https://github.com/${github_user:-richchurcher}/dotfiles.git $DOTFILES
  elif [[ "$1" != "restart" ]]; then
    cd $DOTFILES
    prev_head="$(git rev-parse HEAD)"
    git pull
    if [[ "$(git rev-parse HEAD)" != "$prev_head" ]]; then
      e_header "Changes detected, restarting script"
      exec "$0" "restart"
    fi
  fi
}

init
clone
src
#e_header "Using ${DOTFILES}..."
#link_all
#link_all "config"

