#!/usr/bin/env bash
# Bastardised from https://github.com/cowboy/dotfiles

[[ "$(type -P git)" ]] || { echo "Git required."; exit 1; }
dotfiles_repo="https://github.com/${github_user:-richchurcher}/dotfiles.git"
xdg_config=[[ -d "${HOME}/.config" ]]

function init() {
  if ${xdg_config}; then
    export DOTFILES="${xdg_config}/dotfiles"
  else
    export DOTFILES="${HOME}/.dotfiles"
  fi

  [[ -d $DOTFILES/bin ]] && PATH=$DOTFILES/bin:$PATH
  export PATH

  shopt -s dotglob
  shopt -s nullglob
}

function src() {
  local file
  for file in ${DOTFILES}/lib/*; do
    source "$file"
  done
}

function clone() {
  if [[ ! -d ${DOTFILES} ]]; then
    git clone ${dotfiles_repo} ${DOTFILES}
  elif [[ "$1" != "restart" ]]; then
    cd ${DOTFILES}
    prev_head="$(git rev-parse HEAD)"
    git pull
    if [[ "$(git rev-parse HEAD)" != "$prev_head" ]]; then
      echo "Restarting to incorporate changes"
      exec "$0" "restart"
    fi
  fi
}

init
echo "Using ${DOTFILES}"
echo "Checking for updates at ${dotfiles_repo}"
clone
src
echo "Linking to ${HOME}"
link_all
echo "Linking to XDG config (if it exists)"
[[ ${xdg_config} ]] && link_all "config"

