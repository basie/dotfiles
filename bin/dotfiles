#!/usr/bin/env bash
# Bastardised from https://github.com/cowboy/dotfiles

[[ "$(type -P git)" ]] || { echo "Git required."; exit 1; }
dotfiles_repo="https://github.com/${github_user:-richchurcher}/dotfiles.git"

function init() {
  if [[ -d ~/.config ]]; then
    export DOTFILES="${HOME}/.config/dotfiles";
  else
    export DOTFILES="${HOME}/.dotfiles";
  fi

  [[ -d $DOTFILES/bin ]] && PATH=$DOTFILES/bin:$PATH
  export PATH

  shopt -s dotglob
  shopt -s nullglob
}

function src() {
  local file
  for file in ${DOTFILES}/lib/*; do
    source "$file"
  done
}

function clone() {
  if [[ ! -d ${DOTFILES} ]]; then
    git clone ${dotfiles_repo} ${DOTFILES}
  elif [[ "$1" != "restart" ]]; then
    cd ${DOTFILES}
    prev_head="$(git rev-parse HEAD)"
    git pull
    if [[ "$(git rev-parse HEAD)" != "$prev_head" ]]; then
      echo "Restarting to incorporate changes"
      exec "$0" "restart"
    fi
  fi
}

init
echo "Using ${DOTFILES}"
echo "Checking for updates at ${dotfiles_repo}"
clone
src

link_all
#link_all "config"

